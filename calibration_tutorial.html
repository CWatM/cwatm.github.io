<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>10. Calibration tutorial &#8212; Community Water Model</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="top" title="Community Water Model" href="index.html" />
    <link rel="next" title="11. Model download" href="license.html" />
    <link rel="prev" title="9. Calibration tool" href="calibration.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="license.html" title="11. Model download"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="calibration.html" title="9. Calibration tool"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CWAT Model</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="calibration-tutorial">
<h1>10. Calibration tutorial<a class="headerlink" href="#calibration-tutorial" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line">Calibration tool for hydrological models</div>
<div class="line">in ../CWATM/calibration</div>
</div>
<div class="section" id="calibration-method">
<h2>Calibration method<a class="headerlink" href="#calibration-method" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="what-you-need">
<h2>What you need<a class="headerlink" href="#what-you-need" title="Permalink to this headline">¶</a></h2>
<p>Python 2.7.x 64 bit and a running CWATM (libraries netCDF4, numpy, scipy, GDAL)
In addition: library deap</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Deap can also be used in Python 3.7 but at the moment we did not translate the scripts to Python3.7. it is on the TODO list</p>
</div>
<p>You can install it with:
Pip install deap (you might change into the folder ../python/Scripts/)</p>
<ul class="simple">
<li>Make sure that python 2.7.x is working</li>
<li>Make sure that CWATM is running in non calibration mode</li>
<li>For some of the following steps it is easier to have PCRaster installed: <a class="reference external" href="http://pcraster.geo.uu.nl/">http://pcraster.geo.uu.nl/</a></li>
</ul>
</div>
<div class="section" id="running-calibration">
<h2>Running calibration<a class="headerlink" href="#running-calibration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Look into the settings file of the calibration folder.</p>
</li>
<li><p class="first">look into runCalibration.bat. If python is in your computer path everything should be ok, otherwise put in the path to python</p>
</li>
<li><p class="first">look into templates/runpy.bat. Put the path to python in if necessary</p>
</li>
<li><p class="first">look into templates/settings.ini. Put the pathes in a right way that it fits to your computer:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[FILE_PATHS]
#-------------------------------------------------------
PathRoot = P:/watmodel/CWATM/calibration_tutorial
PathOut = $(PathRoot)/output
PathMaps = $(PathRoot)/CWATM_data/cwatm_input
PathMeteo = $(PathRoot)/climate
</pre></div>
</div>
</li>
<li><p class="first">in observed_data/yukon2001.cvs you find the observed data:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">the</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">header</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span> <span class="k">as</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ObservedData</span><span class="p">]</span> <span class="n">Column</span>
<span class="o">-</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">there</span> <span class="n">are</span> <span class="n">enough</span> <span class="n">data</span> <span class="ow">in</span> <span class="p">(</span><span class="kn">from</span> <span class="nn">ForcingStart</span> <span class="n">to</span> <span class="n">ForcingEnd</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">make sure the folder catchments is empty! Before each try this folder has to be empty</p>
</li>
</ol>
</div>
<div class="section" id="run-runcalibration-bat">
<h2>Run runCalibration.bat<a class="headerlink" href="#run-runcalibration-bat" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>go for testing (see below)</li>
<li>go for testing again (see below)</li>
<li>Change use_multiprocessing =1 in settings.txt</li>
<li>Run runCalibration.bat and after some time something should appear on your window</li>
</ol>
</div>
<div class="section" id="for-testing">
<h2>For testing<a class="headerlink" href="#for-testing" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Change use_multiprocessing = 0 in settings.txt</li>
<li>Delete catchments but keep the empty folder</li>
<li>Run runCalibration.bat and wait till catchment/00_001 gets filled, then interrupt</li>
</ul>
<ol class="arabic simple">
<li>Change to catchments/00_001</li>
<li>Run runpy00_001.bat</li>
<li>See what errors come up and change settings-Run00_001.ini</li>
<li>Change template/setting.ini in the same way</li>
<li>Do this again and again till no error</li>
</ol>
</div>
<div class="section" id="running-it-on-your-computer">
<h2>Running it on your computer<a class="headerlink" href="#running-it-on-your-computer" title="Permalink to this headline">¶</a></h2>
<p>It will be really slow on Windows using data on the the server – next step run it on your PC</p>
<ul>
<li><p class="first">copy the whole folder P:watmodelCWATMcalibration_tutorial to your PC (only 15 GB)</p>
</li>
<li><p class="first">(but maybe you have already parts of it on your computer – like the big climate input files)</p>
</li>
<li><p class="first">Make it work on your computer:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Changing</span> <span class="n">file</span> <span class="n">paths</span> <span class="ow">in</span> <span class="n">templates</span><span class="o">/</span><span class="n">settings</span><span class="o">.</span><span class="n">ini</span><span class="p">,</span> <span class="n">setting</span><span class="o">.</span><span class="n">txt</span>
<span class="n">Changing</span> <span class="n">the</span> <span class="n">path</span> <span class="k">for</span> <span class="n">python</span> <span class="ow">in</span> <span class="n">runCalibration</span><span class="o">.</span><span class="n">bat</span> <span class="ow">and</span> <span class="n">templates</span><span class="o">/</span><span class="n">runpy</span><span class="o">.</span><span class="n">bat</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="preparation-for-another-catchment">
<h2>Preparation for another catchment<a class="headerlink" href="#preparation-for-another-catchment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="preparing-the-observed-dataset-discharge">
<h3>Preparing the observed dataset – discharge<a class="headerlink" href="#preparing-the-observed-dataset-discharge" title="Permalink to this headline">¶</a></h3>
<p>Calibration works by comparing simulated discharge with observed discharge using an objective function:
Here we use the Kling-Gupta Efficiency but we can also use Nash-Sutcliffe Efficiency . Please find some more information on the objective function an on the evolutionary computation framework used for calibration on: <a class="reference external" href="https://cwatm.github.io/calibration.html">https://cwatm.github.io/calibration.html</a></p>
<ul>
<li><p class="first">The observed values can be stored as daily values or monthly values</p>
</li>
<li><p class="first">The observed values should be at least cover 5 years (best is 10-15 years)</p>
</li>
<li><p class="first">The observed discharge has to be stored as textfile in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>./observed_data/nameofstation.cvs
And has to look like this:
date,yukon_pilot_station
2001-04-01,1302.6
2001-04-02,1302.6
2001-04-03,1302.6
2001-04-04,1302.6
…
…
2013-12-31,2647.6
</pre></div>
</div>
</li>
<li><p class="first">Or:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="p">,</span><span class="n">zhutuo</span>
<span class="mi">2002</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">3229.0</span>
<span class="mi">2002</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">2979.2</span>
<span class="mi">2002</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">01</span><span class="p">,</span><span class="mf">3229.0</span>
</pre></div>
</div>
</li>
</ul>
<p><strong>Format:</strong></p>
<ul>
<li><p class="first">Date format like this year-month-day [yyyy-mm-dd]</p>
</li>
<li><p class="first">Separated by a comma</p>
</li>
<li><p class="first">Discharge in [m3/s]</p>
</li>
<li><p class="first">If a value is missing that is not a problem (as long as the time series is long enough):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="n">should</span> <span class="n">like</span> <span class="n">this</span><span class="p">:</span> <span class="p">(</span><span class="n">no</span> <span class="n">value</span> <span class="n">after</span> <span class="n">the</span> <span class="n">comma</span><span class="p">)</span>
<span class="mi">2002</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span>
</pre></div>
</div>
</li>
<li><p class="first">For each day (or month) a line</p>
</li>
</ul>
<p><strong>Settings.txt</strong></p>
<p>In the settings file the lines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ObservedData</span><span class="p">]</span>
<span class="n">Qtss</span> <span class="o">=</span> <span class="n">observed_data</span><span class="o">/</span><span class="n">zhutuo_2002month</span><span class="o">.</span><span class="n">csv</span>
<span class="n">Column</span> <span class="o">=</span> <span class="n">zhutuo</span>
<span class="n">Header</span> <span class="o">=</span> <span class="n">River</span><span class="p">:</span> <span class="n">Yangtze</span>  <span class="n">station</span><span class="p">:</span> <span class="n">Zhutuo</span>
</pre></div>
</div>
<p>Should correspondent to the name and header in the observed discharge.cvs</p>
<p>The lines:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ForcingStart</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">2002</span>
<span class="n">ForcingEnd</span> <span class="o">=</span> <span class="mi">31</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2013</span>
<span class="o">.</span>
</pre></div>
</div>
<p>Should correspondent to the amount of lines in the observed discharge.cvs</p>
</div>
</div>
<div class="section" id="creating-an-initial-netcdf-file-for-warm-start">
<h2>Creating an initial netcdf file for warm start<a class="headerlink" href="#creating-an-initial-netcdf-file-for-warm-start" title="Permalink to this headline">¶</a></h2>
<p>It is best to have a long warm up phase especially for groundwater:
See also: <a class="reference external" href="https://cwatm.github.io/setup.html#initialisation">https://cwatm.github.io/setup.html#initialisation</a></p>
<p>You can run CWATM for a couple of years (20 years or more) and store the last days storage values in a file. This file can be read in to enable a ‘warm” start</p>
<ul class="simple">
<li>change use_multiprocessing = 0 in settings.txt</li>
<li>Delete catchments but keep the empty folder</li>
<li>Run runCalibration.bat and wait till catchment/00_001 gets filled, then interrupt</li>
<li>Change to catchments/00_001</li>
</ul>
<p><strong>Open the settings-Run_001.init</strong></p>
<ul class="simple">
<li>Change load_initial = True to load_initial = False</li>
<li>save_initial = True</li>
<li>initSave = $(FILE_PATHS:PathRoot)/CWATM_init/testx</li>
<li>StepInit = 31/01/1996   (change it to a date 1 month after your StepStart)</li>
<li>Run runpy00_001.bat</li>
</ul>
<p><span class="raw-html">&rarr;</span> There should be a file ./CWATM_init/testx_19960131.nc</p>
<ul class="simple">
<li>Change to: load_initial = True</li>
<li>initLoad =  $(FILE_PATHS:PathRoot)/CWATM_init/testx_19960131.nc</li>
<li>Run runpy00_001.bat</li>
</ul>
<p><span class="raw-html">&rarr;</span>      If it work then it used the initial file you generate before (that was just a test)</p>
<p><strong>Now change to:</strong></p>
<ul class="simple">
<li>StepStart = 1/1/1961</li>
<li>StepEnd =  31/12/2013</li>
<li>load_initial = False</li>
<li>save_initial = True</li>
<li>initSave = $(FILE_PATHS:PathRoot)/CWATM_init/station_name</li>
<li>StepInit = 31/12/2013</li>
<li>Run runpy00_001.bat</li>
</ul>
<p><span class="raw-html">&rarr;</span>      This should have generated a file ./CWATM_init/station_name_20131231.nc</p>
<p><strong>And again:</strong></p>
<ul class="simple">
<li>StepStart = 1/1/1961 (some 20 years or longer)</li>
<li>StepEnd =  31/12/1995 (a day before your normal running day)</li>
<li>load_initial = True</li>
<li>initLoad =  $(FILE_PATHS:PathRoot)/CWATM_init/station_name_20131231.nc</li>
<li>save_initial = True</li>
<li>initSave = $(FILE_PATHS:PathRoot)/CWATM_init/station_name</li>
<li>StepInit = 31/12/1995  (a day before your running day)</li>
<li>Run runpy00_001.bat</li>
</ul>
<p><span class="raw-html">&rarr;</span> This should have generated a file ./CWATM_init/station_name_19951231.nc</p>
<p><strong>And last part:</strong></p>
<ul class="simple">
<li>Change StepStart and StepEnd back to original values</li>
<li>load_initial = True</li>
<li>initLoad =  $(FILE_PATHS:PathRoot)/CWATM_init/station_name_19951231.nc</li>
<li>save_initial = False</li>
<li>Run runpy00_001.bat</li>
</ul>
<p><span class="raw-html">&rarr;</span> If it works, do the same in the ./template/settings.ini</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You have now a “warm” start for every calibration run</p>
</div>
</div>
<div class="section" id="cutting-out-a-catchment-as-mask-map">
<h2>Cutting out a catchment as mask map<a class="headerlink" href="#cutting-out-a-catchment-as-mask-map" title="Permalink to this headline">¶</a></h2>
<p>See the .doc file in
P:watmodelCWATMcalibration_tutorialcalibrationtoolscut_catchmentFor a description:</p>
<p><strong>Requirements:</strong> PCRASTER:</p>
<p>We do no need the python version, I think downloading, extracting and setting of the paths in
P:watmodelCWATMcalibration_tutorialcalibrationtoolscut_catchmentcatchconfig_win.ini
Creating the 2 potential evaporation files in advance</p>
<p>Potential evaporation is Calculated with Penman-Monteith in CWATM, but it is not part of the calibration = there is no change in pot. Evaporation. In order to make the calibration computational faster the results of pot evaporation could be stored and used every time.</p>
<p>For the 30min this is done already as global map set, but for the 5min these files become too big. So they have to be produced for each basin separately</p>
<p>Same preparation as for <strong>Creating an initial netcdf file for warm start</strong>  see above
There should be a folder catchments00_001 with a working run for 001.</p>
<p><strong>Open the settings-Run_001.init</strong></p>
<p>Change:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[Option] calc_evaporation = True
[TIME-RELATED_CONSTANTS] SpinUp = None
[EVAPORATION]
OUT_Dir = $(FILE_PATHS:PathOut)
OUT_MAP_Daily = ETRef, EWRef
</pre></div>
</div>
<p><strong>Run runpy00_001.bat</strong>
<span class="raw-html">&rarr;</span>      There should be a file ETRef.nc and EWRef in the output directory</p>
<p>Rename the files e.g. ETRef.nc to ETRef_yangtze.nc, EWRef.nc to EWRef_yangtze.nc and copy it to PathMeteo (or somewhere else, you have to put the path in)</p>
<p><strong>Open the settings-Run_001.init</strong></p>
<p>Change:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[Option] calc_evaporation = False
[TIME-RELATED_CONSTANTS] SpinUp = -&gt; to the time it was before
[Meteo]
daily reference evaporation (free water)
E0Maps = $(FILE_PATHS:PathMeteo)/EWRef_yangtze
daily reference evapotranspiration (crop)
ETMaps = $(FILE_PATHS:PathMeteo)/ETRef_yangtze
[EVAPORATION]
OUT_Dir = $(FILE_PATHS:PathOut)       !!! outcomment this again - important
OUT_MAP_Daily = ETRef, EWRef
</pre></div>
</div>
<p><strong>Test it:</strong>  Run runpy00_001.bat</p>
<p>And change the settings.ini in templates in the same way</p>
</div>
<div class="section" id="calibration-of-a-downstream-catchment">
<h2>Calibration of a downstream catchment<a class="headerlink" href="#calibration-of-a-downstream-catchment" title="Permalink to this headline">¶</a></h2>
<p>Calibration of a downstream catchment (upstream catchment is already calibrated) can be done using:</p>
<ul class="simple">
<li>The catchment area of the downstream catchment minus the upstream catchment</li>
<li>The missing discharge from the upstream catchment is replaced by an inflow file</li>
</ul>
<ol class="arabic simple">
<li>Cut the mask map, so that the upstream catchment is NOT in the mask map anymore</li>
<li>Detect the point(s) downstream of the inflow points</li>
<li>Run the best calibration scenario(s) of the upstream catchments again to produce long timeserie(s) of the outlet(s) point</li>
<li>Create an inflow file from the long timeseries of outlet(s)</li>
<li>Create a downstream calibration settings (directories, templates etc.)</li>
</ol>
<p><strong>Test the catchment!</strong></p>
<ol class="arabic simple" start="6">
<li>Change the settings file of the downstream calibration so that it includes the inflow from upstream</li>
</ol>
<p><strong>Test it!</strong>
7. Create initial file for warm start</p>
<div class="section" id="cutting-the-mask-map">
<h3>Cutting the mask map<a class="headerlink" href="#cutting-the-mask-map" title="Permalink to this headline">¶</a></h3>
<p>Assuming you have a mask map of the whole catchment (e.g. Yangtze.map and the station points (here Zhutuo 105.75 28.75 and Yichang 111.25 30.75
1. Creating catchment for Zhutuo: catchment 105.75 28.75 ldd_yangtze.map zhu1.map
2. Creating catchment for Yichang: catchment 111.25 30.75 ldd_yangtze.map yi1.map
3. Creating Yichang without Zhutuo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pcrcalc</span> <span class="n">a2</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">cover</span><span class="p">(</span><span class="n">scalar</span><span class="p">(</span><span class="n">zhu1</span><span class="o">.</span><span class="n">map</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">scalar</span><span class="p">(</span><span class="n">yi1</span><span class="o">.</span><span class="n">map</span><span class="p">))</span>
<span class="n">pcrcalc</span> <span class="n">yichang</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">boolean</span><span class="p">(</span><span class="k">if</span><span class="p">(</span><span class="n">a2</span><span class="o">.</span><span class="n">map</span> <span class="n">eq</span> <span class="mi">1</span><span class="p">,</span><span class="n">a2</span><span class="o">.</span><span class="n">map</span><span class="p">))</span>
</pre></div>
</div>
<p>Result is a maskmap: Yichang.map</p>
<a class="reference internal image-reference" href="_images/cal_tutor1.jpg"><img alt="_images/cal_tutor1.jpg" src="_images/cal_tutor1.jpg" style="width: 600px;" /></a>
<p>Figure 1: Upstream catchment (blue) and downstream catchment (red)</p>
</div>
<div class="section" id="detecting-the-downstream-point">
<h3>Detecting the downstream point<a class="headerlink" href="#detecting-the-downstream-point" title="Permalink to this headline">¶</a></h3>
<p>The inflow point of the new catchment has to be in the new mask and preferable one grid cell in flow direction below the upstream station e.g. 1 gridcell North East of Zhutuo (see purple circle in fig. 2)</p>
<p>The inflow point has the lon/lat   106.25 29.25</p>
<a class="reference internal image-reference" href="_images/cal_tutor2.jpg"><img alt="_images/cal_tutor2.jpg" src="_images/cal_tutor2.jpg" style="width: 600px;" /></a>
<p>Figure 2: Downstream point</p>
</div>
<div class="section" id="run-the-best-calibration-scenario-upstream">
<h3>Run the best calibration scenario upstream<a class="headerlink" href="#run-the-best-calibration-scenario-upstream" title="Permalink to this headline">¶</a></h3>
<p>In order to get a long inflow timeserie for the inflow point (here:  Zhutuo)  you need to run the best scenario of the upstream catchment (here: 31_best)</p>
<ul>
<li><p class="first">Change into the folder ../catchments/best</p>
</li>
<li><p class="first">Change settings file from:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">StepStart</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">1996</span>
<span class="n">SpinUp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">2002</span>
<span class="n">StepEnd</span> <span class="o">=</span>  <span class="mi">31</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2013</span>
</pre></div>
</div>
</li>
<li><p class="first">To:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">StepStart</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">1990</span>
<span class="n">SpinUp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">1996</span>
<span class="n">StepEnd</span> <span class="o">=</span>  <span class="mi">31</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">2013</span>
</pre></div>
</div>
</li>
</ul>
<p>Results is a time series from 1/1/1990 – 31/12/2013 in: discharge_daily.tss</p>
</div>
<div class="section" id="create-an-inflow-file-from-the-long-timeseries-of-outlet-s">
<h3>Create an inflow file from the long timeseries of outlet(s)<a class="headerlink" href="#create-an-inflow-file-from-the-long-timeseries-of-outlet-s" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Create a folder ../inflow</li>
<li>Copy the  ../catchments/31_best/discharge_daily.tss to ../inflow/zhutuo.tss</li>
</ul>
</div>
<div class="section" id="create-a-downstream-calibration-settings-directories-templates-etc">
<h3>Create a downstream calibration settings (directories, templates etc.)<a class="headerlink" href="#create-a-downstream-calibration-settings-directories-templates-etc" title="Permalink to this headline">¶</a></h3>
<p>Create downstream calibration settings as before</p>
<ul class="simple">
<li>Copy everything from upstream catchment (e.g. zhutuo) but not catchments</li>
<li>Create empty catchments folder</li>
<li>Create a observed discharge file in observed</li>
<li>Change settings.txt accordingly</li>
<li>Change settings.ini accordingly</li>
</ul>
<p><strong>Test the catchment setting!</strong></p>
<p><strong>But do not create an initial run yet!</strong></p>
</div>
<div class="section" id="change-the-settings-file">
<h3>Change the settings file<a class="headerlink" href="#change-the-settings-file" title="Permalink to this headline">¶</a></h3>
<p>Change the settings file of the downstream calibration so that it includes the inflow from upstream
Change the part of the settings.ini:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>[Option]
inflow = True
[INFLOW]
#-------------------------------------------------------
# if option inflow = true
# the inflow from outside is added as inflowpoints
In_Dir = $(FILE_PATHS:PathRoot)/calibration/calibration_yichang/inflow
# nominal map with locations of (measured)inflow hydrographs [cu m / s]
InflowPoints = 106.25 29.25
InLocal = True
.
# if InflowPoints is a map, this flag is to identify if it is global (False) or local (True)
# observed or simulated input hydrographs as time series [cu m / s]
# Note: that identifiers in time series have to correspond to InflowPoints
# can be several timeseries in one file or different files e.g. main.tss mosel.tss
QInTS = zhutuo.tss
</pre></div>
</div>
<p><strong>Test it!</strong></p>
<p>Generate initial file for warm start
Use initial file for calibration</p>
</div>
</div>
<div class="section" id="joining-best-sub-basin-results-to-calibration-maps">
<h2>Joining best sub-basin results to calibration maps<a class="headerlink" href="#joining-best-sub-basin-results-to-calibration-maps" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>You need all runs done for all sub-basins</li>
<li>A region map</li>
</ol>
<p>For each subbasin a unique number e.g. Zambezi basin</p>
<a class="reference internal image-reference" href="_images/cal_tutor3.jpg"><img alt="_images/cal_tutor3.jpg" src="_images/cal_tutor3.jpg" style="width: 600px;" /></a>
<p>Figure 3 Sub-basin map with a unique identifier for each subbasin</p>
<ol class="arabic" start="3">
<li><p class="first">You need a working PCRaster installation</p>
</li>
<li><p class="first">The settings file settings.txt has to be changed:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">DEFAULT</span><span class="p">]</span>
<span class="n">Root</span> <span class="o">=</span> <span class="n">P</span><span class="p">:</span><span class="o">/</span><span class="n">watmodel</span><span class="o">/</span><span class="n">CWATM</span><span class="o">/</span><span class="n">calibration</span><span class="o">/</span><span class="n">calibration_zambezi</span>
<span class="c1"># root directory where all subbasin are in</span>
<span class="o">.</span>
<span class="p">[</span><span class="n">Catchments</span><span class="p">]</span>
<span class="n">catch</span> <span class="o">=</span> <span class="n">lukulu</span><span class="p">,</span> <span class="n">katima</span><span class="p">,</span> <span class="n">kafue</span><span class="p">,</span> <span class="n">luangwa</span><span class="p">,</span> <span class="n">kwando</span><span class="p">,</span> <span class="n">tete</span>
<span class="c1"># name of the subbasin, has to be the same as the folder name in root</span>
<span class="c1"># the order has to be the same as in the region map</span>
<span class="o">.</span>
<span class="p">[</span><span class="n">region</span><span class="p">]</span>
<span class="n">regionmap</span> <span class="o">=</span> <span class="n">P</span><span class="p">:</span><span class="o">/</span><span class="n">watmodel</span><span class="o">/</span><span class="n">CWATM</span><span class="o">/</span><span class="n">calibration_tutorial</span><span class="o">/</span><span class="n">calibration</span><span class="o">/</span><span class="n">CreateCalibrationMaps</span><span class="o">/</span><span class="n">zambezi_regions</span><span class="o">.</span><span class="n">map</span>
<span class="c1"># region map, the order has to be the same a [Catchment]</span>
<span class="o">.</span>
<span class="p">[</span><span class="n">Path</span><span class="p">]</span>
<span class="n">Templates</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">templates</span>
<span class="n">SubCatchmentPath</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">catchments</span>
<span class="n">ParamRanges</span> <span class="o">=</span> <span class="o">%</span><span class="p">(</span><span class="n">Root</span><span class="p">)</span><span class="n">s</span><span class="o">/</span><span class="n">Join</span><span class="o">/</span><span class="n">ParamRanges</span><span class="o">.</span><span class="n">csv</span>
<span class="o">.</span>
<span class="n">Result</span> <span class="o">=</span> <span class="n">P</span><span class="p">:</span><span class="o">/</span><span class="n">watmodel</span><span class="o">/</span><span class="n">CWATM</span><span class="o">/</span><span class="n">calibration_tutorial</span><span class="o">/</span><span class="n">calibration</span><span class="o">/</span><span class="n">CreateCalibrationMaps</span><span class="o">/</span><span class="n">results</span>
<span class="c1"># here are the results</span>
<span class="o">.</span>
<span class="n">PCRHOME</span> <span class="o">=</span> <span class="n">C</span><span class="p">:</span>\<span class="n">PCRaster</span>\<span class="nb">bin</span>
<span class="c1"># Where is your PCraster installation?</span>
</pre></div>
</div>
</li>
<li><p class="first">Run python CAL_5_PARAMETER_MAPS.py</p>
</li>
</ol>
</div>
<div class="section" id="calibration-parameters">
<h2>Calibration parameters<a class="headerlink" href="#calibration-parameters" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line"><strong>Snow</strong></div>
<div class="line">1.    Snowmelt coefficient in [m/C deg/day]  as a degree-day factor</div>
<div class="line"><strong>Evapotranspiration</strong></div>
<div class="line">2.    Crop factor as an adjustment to crop evapotranspiration</div>
<div class="line"><strong>Soil</strong></div>
<div class="line">3.    Soil depth factor: a factor for the overall soil depth of soil layer 1 and 2</div>
<div class="line">4.    Preferential bypass flow: empirical shape parameter of the preferential flow relation</div>
<div class="line">5.    Infiltration capacity parameter: empirical shape parameter b of the ARNO model</div>
<div class="line"><strong>Groundwater</strong></div>
<div class="line">6.    Interflow factor: factor to  adjust the amount which percolates from interflow to groundwater</div>
<div class="line">7.    Recession coefficient factor: factor to adjust the base flow recession constant (the contribution from groundwater to baseflow)</div>
<div class="line"><strong>Routing</strong></div>
<div class="line">8.    Runoff concentration factor: a factor for the concentration time of run-off in each grid-cell</div>
<div class="line">9.    Channel Manning&#8217;s n factor: a factor roughness in channel routing</div>
<div class="line">10.   Channel, lake and river evaporation factor: factor to adjust open water evaporation</div>
<div class="line"><strong>Reservoir &amp; lakes</strong></div>
<div class="line">11.   Normal storage limit: the fraction of storage capacity used as normal storage limit</div>
<div class="line">12.   Lake A factor : factor to channel width and weir coefficient as a part of the Poleni weir equation</div>
</div>
</div>
<div class="section" id="calibration-tool-structure">
<h2>Calibration tool structure<a class="headerlink" href="#calibration-tool-structure" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Beck, H. E., A. I. J. M. van Dijk, A. de Roo, D. G. Miralles, T. R. McVicar, J. Schellekens and L. A. Bruijnzeel (2016). &#8220;Global-scale regionalization of hydrologic model parameters.&#8221; Water Resources Research 52(5): 3599-3622.</li>
<li>Deb, K., A. Pratap, S. Agarwal and T. Meyarivan (2002). &#8220;A fast and elitist multiobjective genetic algorithm: NSGA-II.&#8221; IEEE Transactions on Evolutionary Computation 6(2): 182-197.</li>
<li>Fortin, F. A., F. M. De Rainville, M. A. Gardner, M. Parizeau and C. Gagńe (2012). &#8220;DEAP: Evolutionary algorithms made easy.&#8221; Journal of Machine Learning Research 13: 2171-2175.</li>
<li>Greve, P., L. Gudmundsson, B. Orlowsky and S. I. Seneviratne (2016). &#8220;A two-parameter Budyko function to represent conditions under which evapotranspiration exceeds precipitation.&#8221; Hydrology and Earth System Sciences 20(6): 2195-2205.</li>
<li>Gupta, H. V., H. Kling, K. K. Yilmaz and G. F. Martinez (2009). &#8220;Decomposition of the mean squared error and NSE performance criteria: Implications for improving hydrological modelling.&#8221; Journal of Hydrology 377(1-2): 80-91.</li>
<li>Kling, H., M. Fuchs and M. Paulin (2012). &#8220;Runoff conditions in the upper Danube basin under an ensemble of climate change scenarios.&#8221; Journal of Hydrology 424-425: 264-277.</li>
<li>Samaniego, L., R. Kumar, S. Thober, O. Rakovec, M. Zink, N. Wanders, S. Eisner, H. Müller Schmied, E. Sutanudjaja, K. Warrach-Sagi and S. Attinger (2017). &#8220;Toward seamless hydrologic predictions across spatial scales.&#8221; Hydrology and Earth System Sciences 21(9): 4323-4346.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/CWATM1.jpg" alt="Logo"/>
            </a></p>
<h3><a href="index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="modeldesign.html">2. Model Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="publication.html">3. Publication</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">4. Setup of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">5. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="results.html">6. Demo of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">7. The Model Itself</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">8. Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="calibration.html">9. Calibration tool</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">10. Calibration tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#calibration-method">Calibration method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-you-need">What you need</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-calibration">Running calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-runcalibration-bat">Run runCalibration.bat</a></li>
<li class="toctree-l2"><a class="reference internal" href="#for-testing">For testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-it-on-your-computer">Running it on your computer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation-for-another-catchment">Preparation for another catchment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-an-initial-netcdf-file-for-warm-start">Creating an initial netcdf file for warm start</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cutting-out-a-catchment-as-mask-map">Cutting out a catchment as mask map</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibration-of-a-downstream-catchment">Calibration of a downstream catchment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#joining-best-sub-basin-results-to-calibration-maps">Joining best sub-basin results to calibration maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibration-parameters">Calibration parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calibration-tool-structure">Calibration tool structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">11. Model download</a></li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="calibration.html"
                        title="previous chapter">9. Calibration tool</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="license.html"
                        title="next chapter">11. Model download</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="license.html" title="11. Model download"
             >next</a> |</li>
        <li class="right" >
          <a href="calibration.html" title="9. Calibration tool"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">CWAT Model</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, PB.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>